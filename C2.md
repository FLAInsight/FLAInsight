# Title

(C2) Code Logic Vulnerabilities Exploited By Flash Loan Attacks


## Sample

### Incident

> [2023/3/13] Euler Finance Attack: https://www.immunebytes.com/blog/euler-finance-hack-mar-13-2023-detailed-hack-analysis/

### Code

>  https://etherscan.io/address/0x27182842e098f60e3d576794a5bffb0777e025d3


### Attack Process

![euler-2(1)(1)](https://github.com/user-attachments/assets/ae0a6b67-d1ad-4020-a5b9-0f71dbae380f)


eDai represents the certificate for users' Dai stored in Euler Finance. dDai represents the loan applied for by users in Euler Finance.

Steps:

1. The attacker initiated a Flash Loan from Aave, borrowing 30 million DAI.

2. The attacker provided 20 million DAI to Euler Finance in exchange for 19.56 million eDai, (the ratio between eDai and DAI is not 1:1, likely due to fees imposed by Euler Finance).

3. They invoked Euler Finance's "mint" function, creating 195.68 million eDai and 200 million dDai (indicating a 10x leverage application, with 20 million DAI as collateral for borrowing 200 million eDai).

4. To prevent liquidation during subsequent borrowing, the attacker utilized Euler Finance's "repay" function to repay a portion of the loan.

5. In synchronization with step three, the attacker called Euler Finance's "mint" function again, generating 195.68 million eDai and 200 million dDai (similarly, using 10 million DAI as collateral for another 200 million eDai loan).

6. The attacker employed Euler Finance's "donate" function to make a donation to Euler Finance using eDai tokens issued by Euler Finance. This caused the eDai balance in the attacker's contract to be less than the dDai balance, resulting in a decrease in the account's health score, thereby triggering the liquidation operation.

7. Using another account, the attacker performed a liquidation operation on the unhealthy account. Liquidators receive rewards for their actions, gaining access to the assets of the liquidated account. In standard liquidation operations, liquidations occur when the collateral ratio exceeds 1, leading to losses for the liquidated account holder and rewards for the liquidator. However, due to competition and platform fees, profits are reduced. Consequently, liquidating one's own account is unusual, but in this case, the collateral ratio was around 0.8, ensuring that liquidators would profit, albeit at the expense of the liquidated account.

8. Following the successful liquidation, the attacker discovered that the collateral ratio had reached 120\%. Subsequently, they called the "withdraw" function to convert eDai into DAI. After retrieving 38 million DAI, the account's collateral ratio remained at 105\%, making it a safe account. Therefore, the "withdraw" function executed without any issues. Ultimately, the attacker successfully obtained 38 million DAI.

9. The attacker repaid the Flash Loan to Aave, returning 30.027 million DAI.

